#!/usr/bin/env bash

set -e

main() {
    local name=$(basename "$1" .asm)
    if [[ "$2" == '--debug' ]]; then
        nasm -ggdb  -f elf64 "$1"
    else
        nasm -f elf64 "$1"
    fi
    if grep -q '##LINK_LIBC##' "$1"; then
        #ld -o "$name" -dynamic-linker /lib64/ld-linux-x86-64.so.2 \
        #        -lc --entry=main "$name".o
        #gcc "$name".o -o "$name"
        echo "Fuck this, it's too big."
    else
        ld -o "$name" "$name".o
    fi
    if [[ "$2" != '--debug' ]]; then
        strip --strip-all "$name"
        strip --remove-section=.note.gnu.build-id "$name"
    fi
    rm "$name".o
}

main "$@"
